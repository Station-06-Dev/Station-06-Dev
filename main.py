import os
import telebot
import google.generativeai as genai
from flask import Flask
from threading import Thread
import time

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub
TOKEN = os.environ.get("TELEGRAM_TOKEN")
API_KEY = os.environ.get("GEMINI_API_KEY")
# –¢–≤–æ–π –±–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
SYSTEM_PROMPT = (
    "–¢—ã ‚Äî –ú–∞–≥–∞—Å, –±–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–π –∏–Ω–≥—É—à—Å–∫–∏–π –ò–ò-–∞–≥–µ–Ω—Ç, –∫–∞–≤–∫–∞–∑–µ—Ü. –¢—ã —Å–æ–≤—Ä–µ–º–µ–Ω–µ–Ω, –Ω–∞—á–∏—Ç–∞–Ω, "
    "—Å–æ–±–ª—é–¥–∞–µ—à—å –∞–¥–∞—Ç—ã –∏ –Ω–æ—Ä–º—ã –ò—Å–ª–∞–º–∞. –õ—é–±–∏—à—å –≥–æ—Ä—ã, —Å–ø–æ—Ä—Ç, –º–∞—à–∏–Ω—ã –∏ –ª–µ–∑–≥–∏–Ω–∫—É. "
    "–¢–≤–æ–π –¥–µ–≤–∏–∑: '–í—ã—à–µ –ø–∞–ø–∞—Ö–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–±–æ'. –ó–∞—â–∏—â–∞–π —á–µ—Å—Ç—å –∂–µ–Ω—â–∏–Ω –∏ —Å–ª–∞–±—ã—Ö. "
    "–û—Ç–≤–µ—á–∞–π –¥–æ—Å—Ç–æ–π–Ω–æ, —Å —É–≤–∞–∂–µ–Ω–∏–µ–º –∏ –ª–µ–≥–∫–∏–º –∫–∞–≤–∫–∞–∑—Å–∫–∏–º –∫–æ–ª–æ—Ä–∏—Ç–æ–º."
)

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Gemini
genai.configure(api_key=API_KEY)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º—É—é —Å—Ç–∞–±–∏–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
model = genai.GenerativeModel('gemini-1.5-flash')

# 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞
bot = telebot.TeleBot(TOKEN)

# 4. Flask-—Å–µ—Ä–≤–µ—Ä (—á—Ç–æ–±—ã –±–æ—Ç –Ω–µ "–∑–∞—Å—ã–ø–∞–ª" –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
app = Flask(__name__)

@app.route('/')
def home():
    return "–ú–∞–≥–∞—Å –Ω–∞ –ø–æ—Å—Ç—É. –°–≤—è–∑—å —Å –≥–æ—Ä–∞–º–∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞."

def run_web():
    port = int(os.environ.get("PORT", 8080))
    app.run(host='0.0.0.0', port=port)

# 5. –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
@bot.message_handler(func=lambda message: True)
def handle_msg(message):
    try:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ú–∞–≥–∞—Å –ø–µ—á–∞—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç
        bot.send_chat_action(message.chat.id, 'typing')
        
        # –ó–∞–ø—Ä–æ—Å –∫ –ò–ò
        full_query = f"{SYSTEM_PROMPT}\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.text}"
        response = model.generate_content(full_query)
        
        if response and response.text:
            bot.reply_to(message, response.text)
        else:
            bot.reply_to(message, "–ú–∞–≥–∞—Å –∑–∞–¥—É–º–∞–ª—Å—è –∏ –ø—Ä–æ–º–æ–ª—á–∞–ª. –ü–æ–ø—Ä–æ–±—É–π —Å–ø—Ä–æ—Å–∏—Ç—å –∏–Ω–∞—á–µ, –π–∏—à.")
            
    except Exception as e:
        error_str = str(e)
        print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {error_str}")
        
        # –ü–æ–Ω—è—Ç–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –æ—à–∏–±–∫–∏ –ø—Ä—è–º–æ –≤ –¢–µ–ª–µ–≥—Ä–∞–º
        if "API_KEY_INVALID" in error_str or "403" in error_str:
            diag = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ó–∞–π–¥–∏ –≤ Secrets –Ω–∞ GitHub –∏ –æ–±–Ω–æ–≤–∏ GEMINI_API_KEY (–ø—Ä–æ–≤–µ—Ä—å, –Ω–µ—Ç –ª–∏ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤)."
        elif "429" in error_str:
            diag = "‚è≥ –õ–∏–º–∏—Ç—ã Google –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ú–∞–≥–∞—Å—É –Ω—É–∂–Ω–æ —Å–æ–≤–µ—Ä—à–∏—Ç—å –¥—É–∞ –∏ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å 5-10 –º–∏–Ω—É—Ç."
        elif "404" in error_str:
            diag = "üîé –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ—Ç –∫–ª—é—á –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–µ—Ä—Å–∏—é gemini-1.5-flash."
        else:
            diag = f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: {error_str[:100]}"
            
        bot.reply_to(message, f"–°–∞–ª–∞–º! –ö–æ–µ-—á—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:\n\n{diag}")

# 6. –ó–∞–ø—É—Å–∫ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
if __name__ == "__main__":
    # –°–±—Ä–æ—Å —Å—Ç–∞—Ä—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (Webhook)
    try:
        bot.remove_webhook()
        time.sleep(1)
    except:
        pass
    
    # –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    Thread(target=run_web).start()
    
    print("–ú–∞–≥–∞—Å –≤—ã—à–µ–ª –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–æ... –ñ–¥–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π.")
    # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
    bot.infinity_polling(timeout=20, long_polling_timeout=10)
